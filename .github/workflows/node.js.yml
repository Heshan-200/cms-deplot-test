name: Create .env on EC2
on:
  push:
    branches:
      - main

jobs:
  create-env:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.MY_EC2_PRIVATE_KEY }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
      - name: Create .env file locally
        run: |
          echo "Creating .env file locally..."
          rm -f .env
          touch .env
          # Write secrets to a temporary file
          echo "${{ toJson(secrets) }}" > secrets.txt
          # Check if secrets.txt was created successfully
          if [ ! -f secrets.txt ]; then
            echo "Error: Failed to create secrets.txt"
            exit 1
          fi
          # Process secrets with Bash, skipping multi-line values
          while IFS=':' read -r key value; do
            # Clean up key and value
            key=$(echo "$key" | tr -d ' ",' | xargs)
            value=$(echo "$value" | tr -d ' ",' | xargs)
            # Skip empty keys or values, and skip if value contains newlines
            if [ -n "$key" ] && [ -n "$value" ] && ! echo "$value" | grep -q $'\n'; then
              echo "$key=$value" >> .env
            fi
          done < <(sed 's/^{//; s/}$//; s/,/\n/g' secrets.txt | tr -d '{}')
          # Clean up
          rm secrets.txt
          echo "Generated .env file:"
          cat .env
      - name: Transfer .env to EC2
        env:
          SSH_HOST: ${{ secrets.MY_EC2_HOST }}
        run: |
          rsync -avz --progress --no-compress -e "ssh -o StrictHostKeyChecking=no -o Ciphers=aes128-ctr -i private_key.pem" .env ubuntu@$SSH_HOST:/home/ubuntu/cms-deploy-test/
          ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@$SSH_HOST << 'EOF'
            # Ensure the target directory exists
            mkdir -p /home/ubuntu/cms-deploy-test/
            echo ".env file transferred successfully"
          EOF
