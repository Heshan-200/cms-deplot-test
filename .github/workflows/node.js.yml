name: Create .env on EC2
on:
  push:
    branches:
      - main

jobs:
  create-env:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.MY_EC2_PRIVATE_KEY }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
      - name: Create .env file locally
        run: |
          echo "Creating .env file locally..."
          rm -f .env
          touch .env
          # Write secrets to a temporary JSON file with proper escaping
          echo "${{ toJson(secrets) }}" > secrets.json
          # Check if secrets.json was created successfully
          if [ ! -f secrets.json ]; then
            echo "Error: Failed to create secrets.json"
            exit 1
          fi
          # Use jq to process the JSON, handling multi-line values
          jq -r 'to_entries | map(.key + "=" + (if (.value | type) == "string" then .value | gsub("\n"; "\\n") else .value | tostring end)) | .[]' secrets.json >> .env
          # Clean up
          rm secrets.json
          echo "Generated .env file:"
          cat .env
      - name: Transfer .env to EC2
        env:
          SSH_HOST: ${{ secrets.MY_EC2_HOST }}
        run: |
          rsync -avz --progress --no-compress -e "ssh -o StrictHostKeyChecking=no -o Ciphers=aes128-ctr -i private_key.pem" .env ubuntu@$SSH_HOST:/home/ubuntu/cms-deploy-test/
          ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@$SSH_HOST << 'EOF'
            # Ensure the target directory exists
            mkdir -p /home/ubuntu/cms-deploy-test/
            echo ".env file transferred successfully"
          EOF
