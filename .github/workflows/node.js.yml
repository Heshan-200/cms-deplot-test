name: Create .env on EC2
on:
  push:
    branches:
      - main

jobs:
  create-env:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.MY_EC2_PRIVATE_KEY }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
      - name: Create .env file locally
        run: |
          echo "Creating .env file locally..."
          rm -f .env
          touch .env
          # Write the custom .env template with specific secrets
          cat << 'EOF' > .env
          # Server
          HOST=0.0.0.0
          PORT=${{ secrets.PORT }}

          # Secrets
          APP_KEYS=${{ secrets.APP_KEYS }}
          API_TOKEN_SALT=${{ secrets.API_TOKEN_SALT }}
          ADMIN_JWT_SECRET=${{ secrets.ADMIN_JWT_SECRET }}
          TRANSFER_TOKEN_SALT=${{ secrets.TRANSFER_TOKEN_SALT }}

          # Database
          DATABASE_CLIENT=${{ secrets.DATABASE_CLIENT }}
          DATABASE_HOST=${{ secrets.DATABASE_HOST }}
          DATABASE_PORT=${{ secrets.DATABASE_PORT }}
          DATABASE_NAME=${{ secrets.DATABASE_NAME }}
          DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
          DATABASE_SSL=${{ secrets.DATABASE_SSL }}
          DATABASE_FILENAME=${{ secrets.DATABASE_FILENAME }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          TEST_ENV=${{ secrets.TEST_ENV }}
          EOF
          echo "Generated .env file:"
          cat .env
      - name: Transfer .env to EC2
        env:
          SSH_HOST: ${{ secrets.MY_EC2_HOST }}
        run: |
          rsync -avz --progress --no-compress -e "ssh -o StrictHostKeyChecking=no -o Ciphers=aes128-ctr -i private_key.pem" .env ubuntu@$SSH_HOST:/home/ubuntu/cms-deploy-test/
          ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@$SSH_HOST << 'EOF'
            # Ensure the target directory exists
            mkdir -p /home/ubuntu/cms-deploy-test/
            echo ".env file transferred successfully"
          EOF
